name: Build Android APK

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'
      
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev wget
      
      - name: Clean and setup SDK
        run: |
          # Полная очистка
          rm -rf ~/.buildozer
          rm -rf ~/.android
          
          # Создаём структуру
          mkdir -p ~/.buildozer/android/platform/android-sdk/cmdline-tools/latest
          mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
          mkdir -p ~/.buildozer/android/platform/android-sdk/build-tools/34.0.0
          
          # Скачиваем command line tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-*.zip
          mv cmdline-tools/* ~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/
          
          # Добавляем в PATH
          export PATH=$PATH:~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin
          
          # Принимаем все лицензии (создаём файлы)
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
          
          # Устанавливаем platform-tools
          yes | sdkmanager --sdk_root=~/.buildozer/android/platform/android-sdk "platform-tools" "platforms;android-33"
          
          # ВАЖНО: Создаём пустую папку build-tools, чтобы buildozer не пытался её скачать
          mkdir -p ~/.buildozer/android/platform/android-sdk/build-tools/34.0.0
          
          # Создаём ссылку для совместимости
          mkdir -p ~/.buildozer/android/platform/android-sdk/tools/bin
          ln -sf ~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
          
          # Проверяем
          echo "✅ SDK готов"
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install cython virtualenv
          pip install buildozer
      
      - name: Build APK
        run: |
          # Указываем явные пути
          export ANDROID_HOME=~/.buildozer/android/platform/android-sdk
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          
          # Создаём локальный файл .buildozerrc с настройками
          mkdir -p ~/.buildozer
          cat > ~/.buildozer/buildozer.spec << 'EOF'
          [app]
          title = Метеостанция
          package.name = meteorstation
          package.domain = org.yourname
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas,txt,json
          version = 0.1
          requirements = python3,kivy,pyjnius,android
          orientation = portrait
          fullscreen = 0
          
          [buildozer]
          log_level = 2
          
          [android]
          api = 33
          minapi = 21
          ndk = 25b
          android.accept_sdk_license = True
          android.build_tools_version = 34.0.0
          android.permissions = BLUETOOTH_SCAN, BLUETOOTH_CONNECT, BLUETOOTH_ADMIN, ACCESS_FINE_LOCATION
          android.extra_permissions = android.permission.BLUETOOTH_SCAN, android.permission.BLUETOOTH_CONNECT
          p4a.branch = develop
          EOF
          
          # Копируем в рабочую директорию
          cp ~/.buildozer/buildozer.spec ./buildozer.spec
          
          # Запускаем сборку
          buildozer android debug
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: bin/*.apk
